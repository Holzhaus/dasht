#!/bin/sh -e
#
# Usage: dasht-docsets-install [NAME...]
#
# Installs available Dash docsets whose names loosely match the given NAMEs.
# You are asked to confirm this destructive operation for every such match.
#
# If no NAMEs are specified, all available docsets are selected for install.
#
# Written in 2016 by Suraj N. Kurapati <https://github.com/sunaku/dasht>
# Distributed under the terms of the ISC license (see the LICENSE file).

: ${DASHT_DOCSETS_DIR:=${XDG_DATA_HOME:-$HOME/.local/share}/dasht/docsets}

# cache the docset download links page to avoid unnecessary network traffic
docset_links_cache="$DASHT_DOCSETS_DIR/docset_links"
wget -T 2 -t 1 -P "$DASHT_DOCSETS_DIR" -N https://kapeli.com/docset_links ||
test -s "$docset_links_cache"

# extract and filter installable docset names from the download links page
set -- $(
  sed -n 's|.*/\([^/]*\)\.tgz.*|\1|p' "$docset_links_cache" |
  sort -u |
  grep -E -i "$(echo "$*" | tr -s ' ' '|')" |
  sed "$(dasht-docsets | awk '{ print "/^" $0 "$/d" }')" # exclude installed
)
printf "Installable docsets ($#):\n\n\t%s\n\n" "$(echo "$*" | sed 's/ /,&/g')"

trap exit INT # let Control-C abort `xargs -p` when running under bash(1)
for docset; do
  echo "Install $docset docset [y/N]" | xargs -p | grep -q . || continue

  basename="$docset".tgz
  tgz="$DASHT_DOCSETS_DIR/$basename"
  url="https://kapeli.com/feeds/$basename"

  wget -P "$DASHT_DOCSETS_DIR" -N -c "$url"
  gzip -t "$tgz" # verify the downloaded file
  tar -v -C "$DASHT_DOCSETS_DIR" -z -x -f "$tgz"
done
