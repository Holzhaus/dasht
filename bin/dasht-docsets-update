#!/bin/sh -e
#
# Usage: dasht-docsets-update [NAME...]
#
# Updates installed Dash docsets whose names loosely match the given NAMEs.
#
# If no NAMEs are specified, all available docsets are selected for update.
#
# Written in 2016 by Suraj N. Kurapati <https://github.com/sunaku/dasht>
# Distributed under the terms of the ISC license (see the LICENSE file).

: ${DASHT_DOCSETS_DIR:=${XDG_DATA_HOME:-$HOME/.local/share}/dasht/docsets}

dasht-docsets "$@" | while read docset; do
  ls "$DASHT_DOCSETS_DIR/$docset"*.tgz
done | sort -u | while read tgz; do
  last_modified_at="$tgz".last_modified_at
  url="https://kapeli.com/feeds/$(basename "$tgz")"

  touch -r "$tgz" "$last_modified_at"
  wget -P "$DASHT_DOCSETS_DIR" -N "$url"
  if test "$tgz" -nt "$last_modified_at"; then
    gzip -t "$tgz" # verify the downloaded file
    tar -v -C "$DASHT_DOCSETS_DIR" -z -x -f "$tgz"
  fi
  rm "$last_modified_at"
done
