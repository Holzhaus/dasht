#!/bin/sh -e
#
# # DASHT-DOCSETS-INHERIT 1       2016-05-28                            2.1.0
#
# ## NAME
#
# dasht-docsets-inherit - inherits [Dash] docsets from other locations
#
# ## SYNOPSIS
#
# `dasht-docsets-inherit` [*OPTION*...] [*LOCATION*...]
#
# ### Examples
#
# `dasht-docsets-inherit`
#   Inherits existing docsets from [Dash], [Zeal], and [helm-dash].
#
# `dasht-docsets-inherit` /some/location/here
#   Inherits existing docsets found in or under `/some/location/here`.
#
# `dasht-docsets-inherit` location1 location2
#   Inherits existing docsets found in or under `location1` and `location2`.
#
# ## DESCRIPTION
#
# Inherits existing [Dash] docsets found in or under the given *LOCATION*s.
# If no *LOCATION*s are given, then the default docset installation locations
# for [Dash], [Zeal], and [helm-dash] will be searched.  Unless this operation
# is forced, you will be prompted to confirm it for every inheritable docset.
#
# If the name of a parent directory of an existing docset contains only digits
# and dashes, then it is considered to be a version number.  This number will
# be appended to the inherited docset's name preceded by an "@" symbol.  In
# particular, "versioned docsets" inherited from [Dash] undergo this renaming.
#
# ## OPTIONS
#
# `-f`, `--force`
#   Forces the operation by overriding the interactive confirmation prompt.
#
# ## ENVIRONMENT
#
# `DASHT_DOCSETS_DIR`
#   Defines the filesystem location where your [Dash] docsets are inherited.
#   If undefined, its value is assumed to be `$XDG_DATA_HOME/dasht/docsets/`
#   or, if `XDG_DATA_HOME` is undefined, `$HOME/.local/share/dasht/docsets/`.
#
# ## SEE ALSO
#
# dasht-docsets-install(1), dasht-docsets-remove(1), dasht-docsets(1), [Dash]
#
# [Dash]: https://kapeli.com/dash
# [Zeal]: https://zealdocs.org
# [helm-dash]: https://github.com/areina/helm-dash
#
# ## AUTHOR
#
# Written in 2016 by Suraj N. Kurapati <https://github.com/sunaku/dasht>
# Distributed under the terms of the ISC license (see the LICENSE file).

: ${DASHT_DOCSETS_DIR:=${XDG_DATA_HOME:-$HOME/.local/share}/dasht/docsets}

test "$1" = '-f' -o "$1" = '--force' && force=1 && shift || unset force

# supply default locations
test $# -eq 0 && set -- \
  "${XDG_DATA_HOME:-$HOME/.local/share}/Zeal/Zeal/docsets" \
  "$HOME/Library/Application Support/Dash" \
  "$HOME/.docsets"

trap exit INT # let Control-C abort `xargs -p` when running under bash(1)
find "$@" -name '*.docset' | while read -r location; do
  # determine the name of the docset along with its version number if any
  rootname=${location%.docset}
  dirname=${location%/*}
  version=${dirname##*/}
  docset=${rootname##*/}
  echo "$version" | grep -E -q '^[0-9-]+$' && docset="$docset@$version"

  test -n "$force" || # don't ask for confirmation when it's being forced
  echo "Inherit $docset docset [y/N]" | xargs -p | grep -q . || continue

  target="$DASHT_DOCSETS_DIR/$docset.docset"
  ln -v -s -f "$location" "$target"
done
